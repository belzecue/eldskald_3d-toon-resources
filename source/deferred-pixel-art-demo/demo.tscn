[gd_scene load_steps=43 format=2]

[ext_resource path="res://deferred-pixel-art-demo/black-material.tres" type="Material" id=1]
[ext_resource path="res://assets/meshes/cone01.obj" type="ArrayMesh" id=2]
[ext_resource path="res://assets/meshes/red-blue-cube-01.obj" type="ArrayMesh" id=3]
[ext_resource path="res://assets/meshes/ground.obj" type="ArrayMesh" id=4]
[ext_resource path="res://rotate.gd" type="Script" id=5]
[ext_resource path="res://icon.png" type="Texture" id=6]
[ext_resource path="res://assets/textures/ibm-pc-colors.png" type="Texture" id=7]
[ext_resource path="res://assets/meshes/cylinder01.obj" type="ArrayMesh" id=8]
[ext_resource path="res://assets/meshes/torus01.obj" type="ArrayMesh" id=9]
[ext_resource path="res://player.tscn" type="PackedScene" id=10]
[ext_resource path="res://demo.gd" type="Script" id=12]
[ext_resource path="res://assets/meshes/pineleaves00.obj" type="ArrayMesh" id=13]
[ext_resource path="res://assets/meshes/treetrunk00.obj" type="ArrayMesh" id=14]
[ext_resource path="res://deferred-pixel-art-demo/albedo-part.shader" type="Shader" id=15]
[ext_resource path="res://deferred-pixel-art-demo/lighting-pass.shader" type="Shader" id=16]

[sub_resource type="ShaderMaterial" id=1]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=2]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 0.5
shader_param/specular_glossiness = 8.0

[sub_resource type="ShaderMaterial" id=3]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=4]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 1.0
shader_param/specular_glossiness = 15.0

[sub_resource type="SphereMesh" id=5]

[sub_resource type="SpatialMaterial" id=6]
flags_unshaded = true
albedo_texture = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=7]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 0.5
shader_param/specular_glossiness = 15.0

[sub_resource type="ShaderMaterial" id=8]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=9]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 0.5
shader_param/specular_glossiness = 15.0

[sub_resource type="ShaderMaterial" id=10]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=11]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 0.5
shader_param/specular_glossiness = 8.0

[sub_resource type="ShaderMaterial" id=12]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=13]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 0.3
shader_param/specular_glossiness = 10.0

[sub_resource type="ShaderMaterial" id=14]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=15]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 1.0
shader_param/specular_glossiness = 15.0

[sub_resource type="ShaderMaterial" id=16]
shader = ExtResource( 15 )
shader_param/albedo = ExtResource( 7 )

[sub_resource type="ShaderMaterial" id=17]
shader = ExtResource( 16 )
shader_param/shade_threshold = 0.0
shader_param/specular_threshold = 1.0
shader_param/specular_glossiness = 15.0

[sub_resource type="ParticlesMaterial" id=18]
spread = 180.0
flatness = 1.0
gravity = Vector3( 0, 5, 0 )
initial_velocity = 1.0
initial_velocity_random = 0.5

[sub_resource type="SpatialMaterial" id=19]
flags_unshaded = true
flags_albedo_tex_force_srgb = true
vertex_color_use_as_albedo = true
albedo_color = Color( 1, 0.333333, 1, 1 )

[sub_resource type="SphereMesh" id=20]
material = SubResource( 19 )
radius = 0.05
height = 0.1

[sub_resource type="Environment" id=21]
background_mode = 1
background_color = Color( 0.0980392, 0, 0, 1 )

[sub_resource type="Environment" id=22]
background_mode = 1
background_color = Color( 0.333333, 1, 1, 1 )

[sub_resource type="Shader" id=23]
code = "// Final Composition
//
// This will read from both camera feeds and render the final image.
shader_type canvas_item;

uniform vec2 resolution;
uniform sampler2D main;
uniform sampler2D lighting;
uniform sampler2D effects;



void fragment() {
	vec2 coords = floor(UV*resolution);
	vec3 main_color = texture(main, UV).rgb;
	vec2 light = texture(lighting, UV).rg;
	vec3 vfx = texture(effects, UV).rgb;
	vec3 color = main_color;
	
	// Checks for shadows
	color += (vec3(0.0) - color)*step(light.x, 0.005)*mod(coords.x + coords.y, 2);
	
	// Checks for specular
	color += (vec3(1.0) - color)*step(0.005, light.y)*step(0.005, light.x)*mod(coords.x + coords.y, 2);
	
	// Checks for visual effects
	color += (vfx - color)*step(0.005, length(vfx - vec3(0.0)));
	
	COLOR = vec4(color, 1.0);
}


"

[sub_resource type="ViewportTexture" id=24]
viewport_path = NodePath("SpecialEffects")

[sub_resource type="ViewportTexture" id=25]
viewport_path = NodePath("ShadowsAndSpecular")

[sub_resource type="ViewportTexture" id=26]
viewport_path = NodePath("MainViewport")

[sub_resource type="ShaderMaterial" id=27]
resource_local_to_scene = true
shader = SubResource( 23 )
shader_param/resolution = Vector2( 256, 144 )
shader_param/main = SubResource( 26 )
shader_param/lighting = SubResource( 25 )
shader_param/effects = SubResource( 24 )

[node name="Spatial" type="Spatial"]
script = ExtResource( 12 )
sec_pass_camera = [ NodePath("ShadowsAndSpecular/Camera"), NodePath("SpecialEffects/Camera") ]

[node name="MainViewport" type="Viewport" parent="."]
size = Vector2( 256, 144 )
handle_input_locally = false
keep_3d_linear = true
render_target_v_flip = true
render_target_update_mode = 3

[node name="DirectionalLight" type="DirectionalLight" parent="MainViewport"]
transform = Transform( 0.965926, -0.12941, 0.224144, 0, 0.866025, 0.5, -0.258819, -0.482963, 0.836516, 0, 0, 6 )
layers = 3
shadow_enabled = true

[node name="Player" parent="MainViewport" instance=ExtResource( 10 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 3 )
speed = 7.0
mouse_sensitivity = 1.5

[node name="Camera" parent="MainViewport/Player" index="0"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 3, 0 )
cull_mask = 1

[node name="RedBlueCube" type="MeshInstance" parent="MainViewport"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2, -1 )
cast_shadow = 0
mesh = ExtResource( 3 )
material/0 = SubResource( 1 )
script = ExtResource( 5 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/RedBlueCube"]
layers = 16384
mesh = ExtResource( 3 )
material/0 = SubResource( 2 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/RedBlueCube"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 3 )
material/0 = ExtResource( 1 )

[node name="Ground" type="MeshInstance" parent="MainViewport"]
cast_shadow = 0
mesh = ExtResource( 4 )
material/0 = SubResource( 3 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Ground"]
layers = 16384
mesh = ExtResource( 4 )
material/0 = SubResource( 4 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Ground"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 4 )
material/0 = ExtResource( 1 )

[node name="Sphere" type="MeshInstance" parent="MainViewport"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 4.05954, 2.16381, 0.995895 )
cast_shadow = 0
mesh = SubResource( 5 )
material/0 = SubResource( 6 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Sphere"]
layers = 16384
mesh = SubResource( 5 )
material/0 = SubResource( 7 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Sphere"]
layers = 2
cast_shadow = 0
mesh = SubResource( 5 )
material/0 = ExtResource( 1 )

[node name="Cone" type="MeshInstance" parent="MainViewport"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 2.92434, 2.03448, -1.72205 )
cast_shadow = 0
mesh = ExtResource( 2 )
material/0 = SubResource( 8 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Cone"]
layers = 16384
mesh = ExtResource( 2 )
material/0 = SubResource( 9 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Cone"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 2 )
material/0 = ExtResource( 1 )

[node name="Cylinder" type="MeshInstance" parent="MainViewport"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, -2.37365, 1.61603, 1.36919 )
cast_shadow = 0
mesh = ExtResource( 8 )
material/0 = SubResource( 10 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Cylinder"]
layers = 16384
mesh = ExtResource( 8 )
material/0 = SubResource( 11 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Cylinder"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 8 )
material/0 = ExtResource( 1 )

[node name="Torus" type="MeshInstance" parent="MainViewport"]
transform = Transform( 2, 0, 0, 0, 2, 0, 0, 0, 2, -5.43669, 1.52002, 4.89599 )
cast_shadow = 0
mesh = ExtResource( 9 )
material/0 = SubResource( 12 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Torus"]
layers = 16384
mesh = ExtResource( 9 )
material/0 = SubResource( 13 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Torus"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 9 )
material/0 = ExtResource( 1 )

[node name="Treetrunk" type="MeshInstance" parent="MainViewport"]
transform = Transform( 0.4, 0, 0, 0, 0.4, 0, 0, 0, 0.4, -6, 0.1, -3 )
cast_shadow = 0
mesh = ExtResource( 14 )
material/0 = SubResource( 14 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Treetrunk"]
layers = 16384
mesh = ExtResource( 14 )
material/0 = SubResource( 15 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Treetrunk"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 14 )
material/0 = ExtResource( 1 )

[node name="Pineleaves" type="MeshInstance" parent="MainViewport/Treetrunk"]
transform = Transform( 2.5, 0, 0, 0, 2.5, 0, 0, 0, 2.5, 0, 5.8, 0 )
cast_shadow = 0
mesh = ExtResource( 13 )
material/0 = SubResource( 16 )

[node name="Lighting" type="MeshInstance" parent="MainViewport/Treetrunk/Pineleaves"]
layers = 16384
mesh = ExtResource( 13 )
material/0 = SubResource( 17 )

[node name="VFXPart" type="MeshInstance" parent="MainViewport/Treetrunk/Pineleaves"]
layers = 2
cast_shadow = 0
mesh = ExtResource( 13 )
material/0 = ExtResource( 1 )

[node name="Particles" type="Particles" parent="MainViewport"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 4 )
layers = 2147483650
cast_shadow = 0
amount = 32
lifetime = 2.0
preprocess = 600.0
speed_scale = 0.1
local_coords = false
process_material = SubResource( 18 )
draw_pass_1 = SubResource( 20 )

[node name="ShadowsAndSpecular" type="Viewport" parent="."]
size = Vector2( 256, 144 )
handle_input_locally = false
keep_3d_linear = true
render_target_v_flip = true
render_target_update_mode = 3
shadow_atlas_size = 4096

[node name="Camera" type="Camera" parent="ShadowsAndSpecular"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 3, 3 )
cull_mask = 16384
environment = SubResource( 21 )
fov = 50.0

[node name="SpecialEffects" type="Viewport" parent="."]
size = Vector2( 256, 144 )
handle_input_locally = false
keep_3d_linear = true
render_target_v_flip = true
render_target_update_mode = 3

[node name="Camera" type="Camera" parent="SpecialEffects"]
cull_mask = 2
environment = SubResource( 22 )
current = true
fov = 50.0

[node name="Composition" type="TextureRect" parent="."]
light_mask = 0
material = SubResource( 27 )
anchor_right = 1.0
anchor_bottom = 1.0
texture = ExtResource( 6 )
expand = true
__meta__ = {
"_edit_use_anchors_": false
}

[editable path="MainViewport/Player"]
